# CMA Plugin Design Specification

**Version:** 1.0
**Date:** 2026-01-04
**Status:** Draft

---

## 1. Executive Summary

This document specifies the architecture for a CMA (Comparative Market Analysis) plugin integrated into the .NET 8 WPF Windows CRM application. The plugin enables real estate agents to input property attributes, leverages a convergence-based AI agent system to find comparable properties, and generates verified reports (CSV, XLSX, PDF) persisted to the local SQLite database.

### Key Innovation: Convergence-Based Verification

To ensure deterministic results from non-deterministic AI agents, the system employs a **two-agent architecture**:

1. **Analyzer Agent (Inner)**: Searches portals and extracts comparable properties
2. **Verifier Agent (Outer)**: Runs the analyzer iteratively until results converge

Only converged results are written to the database, ensuring reliability and correctness.

---

## 2. System Architecture

### 2.1 High-Level Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CMA PLUGIN - C# .NET 8 ARCHITECTURE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CRM.WPF (Host Application)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         CMA Plugin Component                                â”‚ â”‚
â”‚  â”‚                                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ PropertyFormView  â”‚      â”‚           Verifier Agent                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     (WPF/XAML)    â”‚â”€â”€â”€â”€â”€â–¶â”‚         (Outer Loop)                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                   â”‚      â”‚                                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Address         â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Operation       â”‚      â”‚  â”‚     Convergence Loop               â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Area (mÂ²)       â”‚      â”‚  â”‚                                    â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Bedrooms        â”‚      â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Bathrooms       â”‚      â”‚  â”‚  â”‚ Analyzer â”‚  â”‚ Analyzer â”‚  ...  â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Parking         â”‚      â”‚  â”‚  â”‚ Run 1    â”‚  â”‚ Run 2    â”‚       â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Stratum         â”‚      â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Floor           â”‚      â”‚  â”‚       â”‚             â”‚             â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Amenities       â”‚      â”‚  â”‚       â–¼             â–¼             â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Price/mÂ²        â”‚      â”‚  â”‚   Resultâ‚       Resultâ‚‚    ...    â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Admin fee       â”‚      â”‚  â”‚       â”‚             â”‚             â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Observations    â”‚      â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚              â–¼                    â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”‚ Convergence Detector â”‚        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”‚                      â”‚        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”‚ â€¢ Jaccard Index      â”‚        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”‚ â€¢ Price Variance     â”‚        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”‚ â€¢ Count Stability    â”‚        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚              â”‚                    â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚              â–¼                    â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â”‚  Converged = true?   â”‚        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚                 â”‚ YES                   â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚                 â–¼                       â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚       Consensus Builder            â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚  â€¢ Merge verified properties       â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚  â€¢ Deduplicate by address          â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚  â€¢ Calculate price consensus       â”‚  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                â”‚                           â”‚ â”‚
â”‚  â”‚                                                â–¼                           â”‚ â”‚
â”‚  â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚                             â”‚         CSV Output (Consensus)          â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ All comparable properties            â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ ALL portal links included            â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ Verification flags per row           â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ Convergence metadata                 â”‚   â”‚ â”‚
â”‚  â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                â”‚                           â”‚ â”‚
â”‚  â”‚                                                â–¼                           â”‚ â”‚
â”‚  â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚                             â”‚    Deterministic Report Converter       â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚                                          â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚ClosedXML   â”‚    â”‚ QuestPDF        â”‚   â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â”‚ (XLSX)     â”‚    â”‚ (PDF)           â”‚   â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚ â”‚
â”‚  â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                               â”‚                            â”‚ â”‚
â”‚  â”‚                                               â–¼                            â”‚ â”‚
â”‚  â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚                             â”‚      SQLite Database Persistence        â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚                                          â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  CmaReport Table:                        â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ Id (GUID, PK)                         â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ SubjectPropertyId (FK)                â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ CreatedAt (DateTime)                  â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ CsvPath, XlsxBlob, PdfBlob            â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ ConvergenceIterations (int)           â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ ConvergenceScore (decimal)            â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ Status (Converged|Failed)             â”‚   â”‚ â”‚
â”‚  â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                â”‚                           â”‚ â”‚
â”‚  â”‚                                                â–¼                           â”‚ â”‚
â”‚  â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚                             â”‚        CRM Event Notification           â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ ReportId                              â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ PropertyAddress                       â”‚   â”‚ â”‚
â”‚  â”‚                             â”‚  â€¢ AvailableFormats: [XLSX, PDF]         â”‚   â”‚ â”‚
â”‚  â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 Convergence-Based Verification Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONVERGENCE-BASED VERIFICATION ARCHITECTURE                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚    Property Input     â”‚
                              â”‚   (User Form Data)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VERIFIER AGENT (Outer Loop)                             â”‚
â”‚                                                                                 â”‚
â”‚  Role: Orchestrate multiple analysis runs and detect convergence                â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Convergence Loop                                â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   Iteration 1    Iteration 2    Iteration 3    ...    Iteration N      â”‚   â”‚
â”‚  â”‚       â”‚              â”‚              â”‚                     â”‚            â”‚   â”‚
â”‚  â”‚       â–¼              â–¼              â–¼                     â–¼            â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚   â”‚Analyzerâ”‚      â”‚Analyzerâ”‚      â”‚Analyzerâ”‚            â”‚Analyzerâ”‚        â”‚   â”‚
â”‚  â”‚   â”‚ Agent â”‚      â”‚ Agent â”‚      â”‚ Agent â”‚            â”‚ Agent â”‚        â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â””â”€â”€â”€â”¬â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚       â”‚              â”‚              â”‚                     â”‚            â”‚   â”‚
â”‚  â”‚       â–¼              â–¼              â–¼                     â–¼            â”‚   â”‚
â”‚  â”‚   Resultâ‚        Resultâ‚‚        Resultâ‚ƒ              ResultN          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                           â”‚
â”‚                                    â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Convergence Detector                               â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   Compare(Resultâ‚, Resultâ‚‚, ..., ResultN)                               â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   Metrics:                                                              â”‚   â”‚
â”‚  â”‚   â€¢ Property Set Overlap (Jaccard Index â‰¥ 0.85)                        â”‚   â”‚
â”‚  â”‚   â€¢ Price Range Variance (CV â‰¤ 5%)                                     â”‚   â”‚
â”‚  â”‚   â€¢ Comparable Count Stability (|Î”| â‰¤ 2)                               â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚  IF convergence_score â‰¥ THRESHOLD for K consecutive runs:       â”‚  â”‚   â”‚
â”‚  â”‚   â”‚      â†’ STOP, emit consensus result                               â”‚  â”‚   â”‚
â”‚  â”‚   â”‚  ELSE IF iterations > MAX_ITERATIONS:                            â”‚  â”‚   â”‚
â”‚  â”‚   â”‚      â†’ FAIL, report non-convergence                              â”‚  â”‚   â”‚
â”‚  â”‚   â”‚  ELSE:                                                           â”‚  â”‚   â”‚
â”‚  â”‚   â”‚      â†’ CONTINUE, run another iteration                           â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                           â”‚
â”‚                                    â”‚ Converged = true                          â”‚
â”‚                                    â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Consensus Builder                                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚   â€¢ Merge converged results (union of verified properties)             â”‚   â”‚
â”‚  â”‚   â€¢ Deduplicate by address/link                                        â”‚   â”‚
â”‚  â”‚   â€¢ Compute final price range (median of medians)                      â”‚   â”‚
â”‚  â”‚   â€¢ Attach convergence metadata (iterations, confidence score)         â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ Consensus Result
                                          â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Write to Database   â”‚
                              â”‚   (Only on converge)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.3 Analyzer Agent Detail (Inner Agent)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ANALYZER AGENT (Inner)                                â”‚
â”‚                                                                                 â”‚
â”‚  Invoked by: Verifier Agent (one invocation per iteration)                      â”‚
â”‚  Independence: No memory of prior runs (stateless)                              â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        System Prompt Builder                            â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Inputs:                                                                â”‚   â”‚
â”‚  â”‚  â€¢ PropertyInput (subject property)                                     â”‚   â”‚
â”‚  â”‚  â€¢ SearchTolerances (area Â±20%, price Â±25%, beds Â±1)                   â”‚   â”‚
â”‚  â”‚  â€¢ PortalURLs (from availablePortals.md)                               â”‚   â”‚
â”‚  â”‚  â€¢ IterationSeed (for controlled variance)                             â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Output: Structured system prompt for LLM                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                           â”‚
â”‚                                    â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         LLM API Client                                  â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Provider: Claude API / OpenAI / Azure OpenAI                           â”‚   â”‚
â”‚  â”‚  Model: claude-3-5-sonnet / gpt-4o (configurable)                       â”‚   â”‚
â”‚  â”‚  Temperature: 0.3 (low but non-zero for variance)                       â”‚   â”‚
â”‚  â”‚  Token Budget: Configurable per request                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                           â”‚
â”‚                                    â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Portal Search Execution                            â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Agent searches each portal:                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ fincaraiz   â”‚  â”‚metrocuadradoâ”‚  â”‚ ciencuadras â”‚  â”‚  properati  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   .com.co   â”‚  â”‚    .com     â”‚  â”‚    .com     â”‚  â”‚   .com.co   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  For each property found:                                               â”‚   â”‚
â”‚  â”‚  â€¢ Extract ALL attributes per schema                                    â”‚   â”‚
â”‚  â”‚  â€¢ Capture direct URL link (MANDATORY)                                  â”‚   â”‚
â”‚  â”‚  â€¢ Note source portal                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                           â”‚
â”‚                                    â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       Response Parser                                   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â€¢ Parse structured output (CSV or JSON)                                â”‚   â”‚
â”‚  â”‚  â€¢ Validate required fields present                                     â”‚   â”‚
â”‚  â”‚  â€¢ Return AnalysisResult object                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.4 Data Flow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Input  â”‚
â”‚ (WPF Form)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      VERIFIER AGENT                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ITERATION LOOP                                            â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  for i = 1 to MAX_ITERATIONS:                              â”‚  â”‚
â”‚  â”‚      result[i] = AnalyzerAgent.Analyze(input, seed=i)      â”‚  â”‚
â”‚  â”‚      score[i] = ConvergenceDetector.Calculate(results)     â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚      if HasConverged(scores, criteria):                    â”‚  â”‚
â”‚  â”‚          consensus = ConsensusBuilder.Build(results)       â”‚  â”‚
â”‚  â”‚          â†’ WRITE TO DATABASE                               â”‚  â”‚
â”‚  â”‚          â†’ RETURN SUCCESS                                  â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â†’ THROW ConvergenceFailedException                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Only on convergence
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CSV Generation    â”‚â”€â”€â”€â”€â–¶â”‚ XLSX/PDF Converter  â”‚
â”‚  (Consensus Data)   â”‚     â”‚ (Deterministic)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  SQLite Database    â”‚
                            â”‚  (Report + Metadata)â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  CRM Notification   â”‚
                            â”‚  (Event Published)  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Canonical Property Schema

The property input schema is implementation-agnostic and maps to the existing `property_schema.json` from the ACM system.

### 3.1 Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `address` | string | Full property address |
| `operation` | enum | ARRIENDO (rent) or VENTA (sale) |
| `area_habitable` | decimal | Habitable area in mÂ² |
| `bedrooms` | integer | Number of bedrooms |
| `bathrooms` | decimal | Number of bathrooms (supports .5 for half-bath) |
| `price_per_m2` | decimal | Target price per square meter |

### 3.2 Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `area_total` | decimal | Total area in mÂ² |
| `parking` | integer | Number of parking spaces (default: 0) |
| `stratum` | integer | Socioeconomic stratum 1-6 (Colombia specific) |
| `floor` | integer | Floor number |
| `construction_age` | integer | Age of construction in years |
| `administration` | decimal | Monthly administration fee |
| `terrace` | boolean | Has terrace |
| `terrace_area` | decimal | Terrace area in mÂ² |
| `elevator` | boolean | Building has elevator |
| `walking_closet` | boolean | Has walking closet |
| `loft` | boolean | Has loft |
| `study_room` | boolean | Has study/TV room |
| `deposit` | integer | Number of storage rooms |
| `interior_exterior` | enum | I (Interior) or E (Exterior) |
| `finish_quality` | integer | Quality of finishes (1-5 scale) |
| `conservation_state` | integer | Conservation state (1-5 scale) |
| `location_quality` | integer | Location rating (1-5 scale) |
| `observations` | string | Additional notes |

---

## 4. Available Portals

Source: `acm/tools/avaiablePortals.md`

### 4.1 Portal Tier Architecture

Portals are categorized by access method and automation level:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PORTAL TIER ARCHITECTURE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  TIER 1: Public Access (Full Automation)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Fincaraiz   â”‚  â”‚Metrocuadradoâ”‚  â”‚ Ciencuadras â”‚  â”‚  Properati  â”‚           â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚           â”‚
â”‚  â”‚ â€¢ Public    â”‚  â”‚ â€¢ Public    â”‚  â”‚ â€¢ Public    â”‚  â”‚ â€¢ Public    â”‚           â”‚
â”‚  â”‚ â€¢ No login  â”‚  â”‚ â€¢ No login  â”‚  â”‚ â€¢ No login  â”‚  â”‚ â€¢ No login  â”‚           â”‚
â”‚  â”‚ â€¢ Direct    â”‚  â”‚ â€¢ Direct    â”‚  â”‚ â€¢ Direct    â”‚  â”‚ â€¢ Direct    â”‚           â”‚
â”‚  â”‚   HTTP      â”‚  â”‚   HTTP      â”‚  â”‚   HTTP      â”‚  â”‚   HTTP      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                                 â”‚
â”‚  TIER 2: User-Delegated Access (Semi-Automation)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚    Facebook Marketplace       â”‚  â”‚         Instagram             â”‚         â”‚
â”‚  â”‚                               â”‚  â”‚                               â”‚         â”‚
â”‚  â”‚ â€¢ Requires user login         â”‚  â”‚ â€¢ Requires user login         â”‚         â”‚
â”‚  â”‚ â€¢ WebView2 integration        â”‚  â”‚ â€¢ WebView2 integration        â”‚         â”‚
â”‚  â”‚ â€¢ User consent required       â”‚  â”‚ â€¢ User consent required       â”‚         â”‚
â”‚  â”‚ â€¢ Human-like delays (5-15s)   â”‚  â”‚ â€¢ Human-like delays (5-15s)   â”‚         â”‚
â”‚  â”‚ â€¢ Max 20 properties/session   â”‚  â”‚ â€¢ Max 20 properties/session   â”‚         â”‚
â”‚  â”‚ â€¢ CAPTCHA â†’ manual solve      â”‚  â”‚ â€¢ CAPTCHA â†’ manual solve      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                                 â”‚
â”‚  TIER 3: Manual Input Fallback                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  User manually searches and pastes property links when:                 â”‚   â”‚
â”‚  â”‚  â€¢ Tier 2 automation is blocked                                         â”‚   â”‚
â”‚  â”‚  â€¢ User prefers not to share session                                    â”‚   â”‚
â”‚  â”‚  â€¢ Rate limiting detected                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Tier 1: Public Access Portals

| Portal | Base URL | Access Method | Status |
|--------|----------|---------------|--------|
| Fincaraiz | https://www.fincaraiz.com.co/ | Direct HTTP | âœ… Enabled |
| Metrocuadrado | https://www.metrocuadrado.com/ | Direct HTTP | âœ… Enabled |
| Ciencuadras | https://www.ciencuadras.com/ | Direct HTTP | âœ… Enabled |
| Properati | https://www.properati.com.co/ | Direct HTTP | âœ… Enabled |

### 4.3 Tier 2: User-Delegated Access Portals (Social Media)

| Portal | Base URL | Access Method | Requirements |
|--------|----------|---------------|--------------|
| Facebook Marketplace | https://www.facebook.com/marketplace/ | WebView2 + User Session | User login, explicit consent |
| Instagram | https://www.instagram.com/ | WebView2 + User Session | User login, explicit consent |

#### 4.3.1 Facebook & Instagram Access Restrictions

**Why Special Handling is Required:**

| Restriction | Facebook Marketplace | Instagram |
|-------------|---------------------|-----------|
| Official API | âŒ No Marketplace API exists | âš ï¸ Limited (no property search) |
| Login Required | âœ… Content behind login wall | âœ… Full content requires login |
| Anti-Scraping | ğŸ”´ Aggressive (billions blocked daily) | ğŸ”´ Aggressive |
| Rate Limits | 200 requests/hour via Graph API | Similar restrictions |
| Terms of Service | Prohibits unauthorized automation | Prohibits unauthorized automation |

**Legal Considerations:**

- A 2024 federal court ruled that Meta's terms "do not bar logged-off scraping of public data" but this is narrow and fact-specific
- Instagram TOS explicitly prohibits automated data collection without permission
- Account suspension and legal action are real risks for violations

#### 4.3.2 User-Delegated Access Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER-DELEGATED ACCESS MODEL                                â”‚
â”‚                                                                                 â”‚
â”‚  Legal Basis: User accesses their OWN account with their OWN credentials.      â”‚
â”‚  The plugin acts as an accessibility/automation aid under user control.        â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚    User     â”‚     â”‚  CRM Plugin      â”‚     â”‚   AI Agent        â”‚           â”‚
â”‚  â”‚ (owns FB/IG â”‚â”€â”€â”€â”€â–¶â”‚  (WebView2       â”‚â”€â”€â”€â”€â–¶â”‚   (Analyzes       â”‚           â”‚
â”‚  â”‚  account)   â”‚     â”‚   Browser)       â”‚     â”‚    results)       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â”‚                     â”‚                                                  â”‚
â”‚        â”‚ 1. User logs in     â”‚ 2. Plugin uses                                  â”‚
â”‚        â”‚    manually         â”‚    session as user                              â”‚
â”‚        â”‚    (one-time)       â”‚                                                 â”‚
â”‚        â–¼                     â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    User's Browser Context                               â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â€¢ WebView2 (Chromium) embedded in WPF                                 â”‚   â”‚
â”‚  â”‚  â€¢ User logs in via normal Facebook/Instagram flow                     â”‚   â”‚
â”‚  â”‚  â€¢ Session cookies captured (with explicit consent dialog)             â”‚   â”‚
â”‚  â”‚  â€¢ Browsing appears as normal user activity                            â”‚   â”‚
â”‚  â”‚  â€¢ Human-like delays: 5-15 seconds between actions (randomized)        â”‚   â”‚
â”‚  â”‚  â€¢ User sees all navigation (transparent operation)                    â”‚   â”‚
â”‚  â”‚  â€¢ CAPTCHA presented to user in WebView for manual solving             â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.3 Hybrid Human-AI Workflow (Fallback)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HYBRID HUMAN-AI MODEL (FALLBACK)                           â”‚
â”‚                                                                                 â”‚
â”‚  Used when: Automation blocked, user prefers manual, rate limited              â”‚
â”‚                                                                                 â”‚
â”‚  Step 1: AI Agent generates search instructions                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  "Search Facebook Marketplace for:                                      â”‚   â”‚
â”‚  â”‚   - Location: Cedritos, BogotÃ¡                                          â”‚   â”‚
â”‚  â”‚   - Type: Apartamento en arriendo                                       â”‚   â”‚
â”‚  â”‚   - Price: $1,500,000 - $2,500,000 COP                                 â”‚   â”‚
â”‚  â”‚   - Bedrooms: 1-2                                                       â”‚   â”‚
â”‚  â”‚   - Area: 30-50 mÂ²                                                      â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Copy the links of matching properties below..."                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Step 2: User manually searches and pastes links                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [ Text area for pasting Facebook/Instagram links ]                     â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  https://www.facebook.com/marketplace/item/123456789                    â”‚   â”‚
â”‚  â”‚  https://www.instagram.com/p/ABC123xyz                                  â”‚   â”‚
â”‚  â”‚  ...                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Step 3: AI Agent processes provided links                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  For each link:                                                         â”‚   â”‚
â”‚  â”‚  â€¢ Validate URL format                                                  â”‚   â”‚
â”‚  â”‚  â€¢ Fetch property details (using user session if available)             â”‚   â”‚
â”‚  â”‚  â€¢ Extract attributes per schema                                        â”‚   â”‚
â”‚  â”‚  â€¢ Add to comparables list                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 Portal Access Decision Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PORTAL ACCESS DECISION FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Portal Request   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Is Tier 1 Portal? â”‚
                              â”‚ (Public Access)   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ YES                             â”‚ NO
                       â–¼                                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Direct HTTP    â”‚              â”‚ Is User Session â”‚
              â”‚  Request        â”‚              â”‚ Available?      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                â”‚
                       â–¼                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ YES                     â”‚ NO
              â”‚  Return Results â”‚          â–¼                         â–¼
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ WebView2 Browse â”‚      â”‚ Prompt User to  â”‚
                                   â”‚ with Session    â”‚      â”‚ Login or Paste  â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ Links Manually  â”‚
                                            â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â–¼                        â”‚
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
                                   â”‚ Rate Limited or â”‚               â”‚
                                   â”‚ Blocked?        â”‚               â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                                            â”‚                        â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                               â”‚ YES                     â”‚ NO        â”‚
                               â–¼                         â–¼           â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                      â”‚ Fall back to    â”‚       â”‚ Extract and     â”‚  â”‚
                      â”‚ Manual Link     â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ Return Results  â”‚  â”‚
                      â”‚ Input           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
                               â”‚                                     â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Service Descriptions

### 5.1 PropertyFormService

```json
{
  "name": "PropertyFormService",
  "triggeringEvent": "User opens CMA plugin from CRM toolbar",
  "deliveredService": "A modal WPF form bound to PropertyInput, with validation and submit capability",
  "assumptions": [
    "CRM host provides plugin injection point",
    "Validation rules match schema constraints",
    "Form state is not persisted until successful submission"
  ],
  "inputs": [
    {
      "name": "existingPropertyId",
      "type": "Guid?",
      "validation": "If provided, loads existing property data for editing"
    }
  ],
  "outputs": [
    {
      "name": "propertyInput",
      "type": "PropertyInput",
      "description": "Validated property data ready for analysis"
    }
  ],
  "errorConditions": [
    {
      "condition": "Required fields missing",
      "exception": "ValidationException"
    },
    {
      "condition": "Price per mÂ² is zero or negative",
      "exception": "ArgumentException"
    }
  ]
}
```

### 5.2 AnalyzerAgent (Inner Agent)

```json
{
  "name": "AnalyzerAgent",
  "triggeringEvent": "Verifier agent requests an analysis iteration",
  "deliveredService": "Raw comparable property list from portal searches",
  "assumptions": [
    "Each invocation is independent (no memory of prior runs)",
    "Temperature > 0 introduces intentional variance for convergence testing",
    "All portal links must be included in output"
  ],
  "inputs": [
    {
      "name": "propertyInput",
      "type": "PropertyInput",
      "validation": "Must be schema-compliant"
    },
    {
      "name": "searchTolerances",
      "type": "SearchToleranceConfig",
      "validation": "Defaults: area Â±20%, price Â±25%, beds Â±1"
    },
    {
      "name": "portals",
      "type": "List<PortalConfiguration>",
      "validation": "At least one enabled portal"
    },
    {
      "name": "iterationSeed",
      "type": "integer",
      "validation": "Unique per iteration for controlled variance"
    }
  ],
  "outputs": [
    {
      "name": "analysisResult",
      "type": "AnalysisResult",
      "description": "Properties found with links, attributes, and source portal"
    }
  ],
  "errorConditions": [
    {
      "condition": "LLM API failure",
      "exception": "AgentExecutionException"
    },
    {
      "condition": "All portals unreachable",
      "exception": "PortalAccessException"
    }
  ],
  "systemPromptRequirements": [
    "Search all enabled portals",
    "Extract ALL property attributes per schema",
    "Include direct URL link for every property (MANDATORY)",
    "Do NOT filter or deduplicate (verifier handles this)"
  ]
}
```

### 5.3 VerifierAgent (Outer Agent)

```json
{
  "name": "VerifierAgent",
  "triggeringEvent": "User submits property form for CMA generation",
  "deliveredService": "Verified, converged analysis written to database",
  "assumptions": [
    "Analyzer agent is non-deterministic but consistent in methodology",
    "Convergence indicates reliability of results",
    "Non-convergence indicates ambiguous or insufficient market data"
  ],
  "inputs": [
    {
      "name": "propertyInput",
      "type": "PropertyInput",
      "validation": "Validated by PropertyFormService"
    },
    {
      "name": "convergenceCriteria",
      "type": "ConvergenceCriteria",
      "validation": "Uses defaults if not specified"
    }
  ],
  "outputs": [
    {
      "name": "consensusResult",
      "type": "ConsensusAnalysisResult",
      "description": "Merged, deduplicated properties with price analysis"
    },
    {
      "name": "convergenceMetadata",
      "type": "ConvergenceMetadata",
      "description": "Iterations count, scores, confidence level"
    }
  ],
  "errorConditions": [
    {
      "condition": "MaxIterations reached without convergence",
      "exception": "ConvergenceFailedException"
    },
    {
      "condition": "Analyzer agent fails on all iterations",
      "exception": "AnalysisFailedException"
    }
  ]
}
```

### 5.4 ConvergenceDetector

```json
{
  "name": "ConvergenceDetector",
  "triggeringEvent": "New analysis result available from iteration",
  "deliveredService": "Convergence score and determination",
  "assumptions": [
    "At least 2 results required to calculate convergence",
    "Property addresses can be normalized for comparison"
  ],
  "inputs": [
    {
      "name": "results",
      "type": "List<AnalysisResult>",
      "validation": "At least 2 results"
    },
    {
      "name": "criteria",
      "type": "ConvergenceCriteria",
      "validation": "Valid thresholds"
    }
  ],
  "outputs": [
    {
      "name": "convergenceScore",
      "type": "ConvergenceScore",
      "description": "Metrics for current iteration pair"
    },
    {
      "name": "hasConverged",
      "type": "boolean",
      "description": "Whether convergence criteria met"
    }
  ],
  "metrics": [
    {
      "name": "PropertySetOverlap",
      "calculation": "Jaccard Index = |A âˆ© B| / |A âˆª B|",
      "threshold": "â‰¥ 0.85"
    },
    {
      "name": "PriceVarianceCoefficient",
      "calculation": "CV = Ïƒ / Î¼ (coefficient of variation)",
      "threshold": "â‰¤ 0.05 (5%)"
    },
    {
      "name": "ComparableCountDelta",
      "calculation": "|count(A) - count(B)|",
      "threshold": "â‰¤ 2"
    }
  ]
}
```

### 5.5 ConsensusBuilder

```json
{
  "name": "ConsensusBuilder",
  "triggeringEvent": "Convergence achieved",
  "deliveredService": "Merged consensus result from all converged iterations",
  "assumptions": [
    "Input results have already met convergence criteria",
    "Properties can be merged by normalized address"
  ],
  "inputs": [
    {
      "name": "convergedResults",
      "type": "List<AnalysisResult>",
      "validation": "All results from convergent iterations"
    }
  ],
  "outputs": [
    {
      "name": "consensusResult",
      "type": "ConsensusAnalysisResult",
      "description": "Final merged analysis"
    }
  ],
  "operations": [
    "Union all properties across runs",
    "Deduplicate by normalized address",
    "Prefer verified links over unverified",
    "Prefer records with most complete data",
    "Calculate median price per mÂ²",
    "Calculate 90% confidence interval for price range"
  ]
}
```

### 5.6 ReportConverterService

```json
{
  "name": "ReportConverterService",
  "triggeringEvent": "Consensus result available",
  "deliveredService": "XLSX and PDF reports in standardized format",
  "assumptions": [
    "Consensus data is schema-compliant",
    "Output directory is writable",
    "ClosedXML and QuestPDF libraries available"
  ],
  "inputs": [
    {
      "name": "consensusResult",
      "type": "ConsensusAnalysisResult",
      "validation": "Non-empty property list"
    },
    {
      "name": "subjectProperty",
      "type": "PropertyInput",
      "validation": "Required for report header"
    },
    {
      "name": "outputDirectory",
      "type": "string",
      "validation": "Directory must exist and be writable"
    }
  ],
  "outputs": [
    {
      "name": "csvPath",
      "type": "string",
      "description": "Path to raw CSV data"
    },
    {
      "name": "xlsxBytes",
      "type": "byte[]",
      "description": "Styled Excel workbook"
    },
    {
      "name": "pdfBytes",
      "type": "byte[]",
      "description": "Formatted PDF report"
    }
  ],
  "errorConditions": [
    {
      "condition": "Output directory not writable",
      "exception": "IOException"
    }
  ]
}
```

### 5.7 CmaReportRepository

```json
{
  "name": "CmaReportRepository",
  "triggeringEvent": "Reports generated successfully",
  "deliveredService": "Reports persisted to SQLite with metadata",
  "assumptions": [
    "SQLite database is initialized",
    "Files fit in BLOB (< 100MB each)"
  ],
  "inputs": [
    {
      "name": "subjectPropertyId",
      "type": "Guid",
      "validation": "Must reference existing property (or create new)"
    },
    {
      "name": "agentUserId",
      "type": "Guid",
      "validation": "Must reference existing user/agent"
    },
    {
      "name": "csvPath",
      "type": "string",
      "validation": "Valid file path"
    },
    {
      "name": "xlsxBytes",
      "type": "byte[]",
      "validation": "Non-empty"
    },
    {
      "name": "pdfBytes",
      "type": "byte[]",
      "validation": "Non-empty"
    },
    {
      "name": "convergenceMetadata",
      "type": "ConvergenceMetadata",
      "validation": "Contains iteration count and scores"
    }
  ],
  "outputs": [
    {
      "name": "reportId",
      "type": "Guid",
      "description": "ID of persisted report"
    }
  ],
  "errorConditions": [
    {
      "condition": "Database write fails",
      "exception": "PersistenceException"
    }
  ]
}
```

### 5.8 CrmNotificationService

```json
{
  "name": "CrmNotificationService",
  "triggeringEvent": "Report persisted to database",
  "deliveredService": "CRM receives notification of new report availability",
  "assumptions": [
    "CRM implements listener interface",
    "Event is published on UI thread for immediate display"
  ],
  "inputs": [
    {
      "name": "reportId",
      "type": "Guid",
      "validation": "Must exist in database"
    },
    {
      "name": "propertyAddress",
      "type": "string",
      "validation": "Non-empty"
    },
    {
      "name": "availableFormats",
      "type": "List<ReportFormat>",
      "validation": "Contains XLSX and/or PDF"
    }
  ],
  "outputs": [
    {
      "name": "notificationAcknowledged",
      "type": "boolean",
      "description": "CRM received and processed event"
    }
  ]
}
```

### 5.9 SocialMediaBrowserService (Tier 2 Portals)

```json
{
  "name": "SocialMediaBrowserService",
  "triggeringEvent": "AI agent requests Facebook/Instagram property search",
  "deliveredService": "Property listings extracted from social media platforms using user's authenticated session",
  "assumptions": [
    "User has logged into their own Facebook/Instagram account",
    "User has granted explicit consent for browser automation",
    "WebView2 runtime is installed on Windows",
    "User's session cookies are stored securely"
  ],
  "inputs": [
    {
      "name": "searchCriteria",
      "type": "PropertySearchCriteria",
      "validation": "Must include location and at least one filter"
    },
    {
      "name": "userSession",
      "type": "BrowserSession",
      "validation": "Valid session with authentication cookies"
    },
    {
      "name": "platform",
      "type": "SocialMediaPlatform",
      "validation": "Facebook or Instagram"
    }
  ],
  "outputs": [
    {
      "name": "properties",
      "type": "List<SocialMediaProperty>",
      "description": "Extracted property listings with links"
    },
    {
      "name": "accessStatus",
      "type": "AccessStatus",
      "description": "Success, RateLimited, Blocked, or ManualRequired"
    }
  ],
  "errorConditions": [
    {
      "condition": "User not logged in",
      "exception": "SessionNotAuthenticatedException"
    },
    {
      "condition": "Rate limit detected",
      "exception": "RateLimitedException"
    },
    {
      "condition": "Account blocked or suspended",
      "exception": "AccountBlockedException"
    },
    {
      "condition": "CAPTCHA challenge presented",
      "exception": "CaptchaRequiredException"
    }
  ],
  "constraints": {
    "maxPropertiesPerSession": 20,
    "delayBetweenRequests": "5-15 seconds (randomized)",
    "maxSessionDuration": "10 minutes",
    "requiresUserConsent": true,
    "requiresVisibleBrowser": true
  },
  "fallbackBehavior": {
    "onRateLimited": "Wait with exponential backoff, then prompt for manual input",
    "onBlocked": "Immediately fall back to manual link input",
    "onCaptcha": "Present CAPTCHA to user in WebView2 for manual solving",
    "onSessionExpired": "Prompt user to re-authenticate"
  }
}
```

### 5.10 ManualLinkInputService (Tier 3 Fallback)

```json
{
  "name": "ManualLinkInputService",
  "triggeringEvent": "Tier 2 automation fails or user prefers manual input",
  "deliveredService": "Property data extracted from user-provided links",
  "assumptions": [
    "User can manually search social media platforms",
    "User can copy and paste property URLs",
    "Links are valid Facebook Marketplace or Instagram URLs"
  ],
  "inputs": [
    {
      "name": "searchInstructions",
      "type": "string",
      "validation": "AI-generated search guidance for user"
    },
    {
      "name": "userProvidedLinks",
      "type": "List<string>",
      "validation": "Valid URLs from supported platforms"
    },
    {
      "name": "userSession",
      "type": "BrowserSession",
      "validation": "Optional - used for fetching link details if available"
    }
  ],
  "outputs": [
    {
      "name": "properties",
      "type": "List<SocialMediaProperty>",
      "description": "Property data extracted from provided links"
    },
    {
      "name": "invalidLinks",
      "type": "List<InvalidLinkResult>",
      "description": "Links that could not be processed with reason"
    }
  ],
  "errorConditions": [
    {
      "condition": "No valid links provided",
      "exception": "NoValidLinksException"
    },
    {
      "condition": "All links failed extraction",
      "exception": "ExtractionFailedException"
    }
  ]
}
```

---

## 6. Convergence Criteria Specification

### 6.1 Default Configuration

| Parameter | Default Value | Description |
|-----------|---------------|-------------|
| `MinPropertySetOverlap` | 0.85 | Minimum Jaccard similarity index |
| `MaxPriceVarianceCoefficient` | 0.05 | Maximum CV (5%) for price consistency |
| `MaxComparableCountDelta` | 2 | Maximum difference in property count |
| `RequiredConsecutiveConvergentRuns` | 2 | Consecutive runs meeting criteria |
| `MinIterations` | 2 | Minimum iterations before checking |
| `MaxIterations` | 5 | Maximum iterations before failure |

### 6.2 Convergence Decision Logic

```
FOR each iteration i from 1 to MaxIterations:

    result[i] = AnalyzerAgent.Execute(property, seed=i)

    IF i < MinIterations:
        CONTINUE

    score[i] = CalculateConvergence(result[i-1], result[i])

    Log: "Iteration {i}: Jaccard={score.Overlap}, PriceVar={score.PriceVar}, Î”={score.CountDelta}"

    IF last K scores ALL meet criteria:
        consensus = BuildConsensus(all results)
        RETURN Success(consensus)

RETURN Failure("Non-convergence after {MaxIterations} iterations")
```

### 6.3 Jaccard Index Calculation

```
Given two property sets A and B (identified by normalized address):

Jaccard(A, B) = |A âˆ© B| / |A âˆª B|

Where:
- |A âˆ© B| = count of properties appearing in BOTH sets
- |A âˆª B| = count of unique properties across BOTH sets

Example:
- Run 1 finds: [Prop1, Prop2, Prop3, Prop4, Prop5]
- Run 2 finds: [Prop1, Prop2, Prop3, Prop6, Prop7]
- Intersection: [Prop1, Prop2, Prop3] = 3
- Union: [Prop1, Prop2, Prop3, Prop4, Prop5, Prop6, Prop7] = 7
- Jaccard = 3/7 = 0.43 (NOT converged, below 0.85 threshold)
```

---

## 7. AI Agent System Prompt Template

```markdown
# Comparative Market Analysis Agent

## Role
You are a real estate market analyst specialized in Colombian property markets.
Your task is to find comparable properties for valuation analysis.

## Available Portals
Search these Colombian real estate portals:
1. fincaraiz.com.co
2. metrocuadrado.com
3. ciencuadras.com
4. properati.com.co

## Subject Property
{PROPERTY_JSON}

## Search Parameters
- Operation: {operation}
- Location: {address_neighborhood}
- Area Range: {area_min} - {area_max} mÂ²
- Bedrooms: {beds_min} - {beds_max}
- Bathrooms: {baths_min} - {baths_max}
- Stratum: {stratum}
- Price/mÂ² Range: ${price_min} - ${price_max}

## Instructions
1. Search each portal for properties matching the criteria
2. Extract ALL available property attributes
3. CRITICAL: Include the direct URL link to each property listing
4. Note the source portal for each property
5. Do NOT filter or deduplicate results (handled by verifier)

## Output Format
Generate a CSV with these columns:
- source_portal
- property_link (REQUIRED - full URL)
- address
- operation
- area_habitable
- area_total
- bedrooms
- bathrooms
- parking
- stratum
- floor
- price_per_m2
- total_price
- administration
- terrace
- elevator
- construction_age
- observations

## Quality Requirements
- Minimum 5 properties per search
- Maximum 50 properties total
- All links must be complete URLs
- All required fields must be populated
```

---

## 8. Database Schema

### 8.1 CmaReport Table

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `Id` | GUID | PK | Unique report identifier |
| `SubjectPropertyId` | GUID | FK, NOT NULL | Link to subject property |
| `AgentUserId` | GUID | FK, NOT NULL | User who generated report |
| `CreatedAt` | DateTime | NOT NULL | Generation timestamp |
| `CsvPath` | TEXT | NOT NULL | Path to source CSV file |
| `XlsxBlob` | BLOB | NOT NULL | Excel report binary |
| `PdfBlob` | BLOB | NOT NULL | PDF report binary |
| `ComparablesCount` | INTEGER | NOT NULL | Number of comparables found |
| `ConvergenceIterations` | INTEGER | NOT NULL | Iterations to converge |
| `ConvergenceScore` | REAL | NOT NULL | Final Jaccard index |
| `RecommendedPriceMin` | REAL | NULL | Lower bound of price range |
| `RecommendedPriceMax` | REAL | NULL | Upper bound of price range |
| `Status` | TEXT | NOT NULL | 'Converged' or 'Failed' |

### 8.2 CmaComparable Table (Optional Detail)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `Id` | GUID | PK | Unique comparable identifier |
| `CmaReportId` | GUID | FK, NOT NULL | Parent report |
| `SourcePortal` | TEXT | NOT NULL | Origin portal |
| `PropertyLink` | TEXT | NOT NULL | Direct URL |
| `Address` | TEXT | NOT NULL | Property address |
| `PricePerM2` | REAL | NOT NULL | Price per square meter |
| `AreaHabitable` | REAL | NOT NULL | Area in mÂ² |
| `Bedrooms` | INTEGER | NOT NULL | Bedroom count |
| `LinkVerified` | BOOLEAN | NOT NULL | Link validation status |

---

## 9. Solution Structure

```
/CRM.sln
â”‚
â”œâ”€â”€ /src
â”‚   â”œâ”€â”€ /CRM.Domain
â”‚   â”‚   â”œâ”€â”€ /Entities
â”‚   â”‚   â”‚   â”œâ”€â”€ Property.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ CmaReport.cs
â”‚   â”‚   â”‚   â””â”€â”€ ComparableProperty.cs
â”‚   â”‚   â”œâ”€â”€ /ValueObjects
â”‚   â”‚   â”‚   â”œâ”€â”€ PropertyInput.cs
â”‚   â”‚   â”‚   â””â”€â”€ Address.cs
â”‚   â”‚   â”œâ”€â”€ /Events
â”‚   â”‚   â”‚   â””â”€â”€ CmaReportGeneratedEvent.cs
â”‚   â”‚   â””â”€â”€ /Exceptions
â”‚   â”‚       â”œâ”€â”€ ConvergenceFailedException.cs
â”‚   â”‚       â”œâ”€â”€ NoComparablesFoundException.cs
â”‚   â”‚       â”œâ”€â”€ RateLimitedException.cs
â”‚   â”‚       â””â”€â”€ SessionNotAuthenticatedException.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ /CRM.Application
â”‚   â”‚   â””â”€â”€ /CmaPlugin
â”‚   â”‚       â”œâ”€â”€ /Convergence
â”‚   â”‚       â”‚   â”œâ”€â”€ ConvergenceCriteria.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ ConvergenceScore.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ ConvergenceMetadata.cs
â”‚   â”‚       â”‚   â””â”€â”€ ConsensusAnalysisResult.cs
â”‚   â”‚       â”œâ”€â”€ /Dtos
â”‚   â”‚       â”‚   â”œâ”€â”€ AnalysisResult.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ CmaRequestDto.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ SearchToleranceConfig.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ SocialMediaProperty.cs
â”‚   â”‚       â”‚   â””â”€â”€ BrowserSession.cs
â”‚   â”‚       â”œâ”€â”€ /Interfaces
â”‚   â”‚       â”‚   â”œâ”€â”€ IAnalyzerAgent.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ IVerifierAgent.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ IConvergenceDetector.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ IConsensusBuilder.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ IReportConverter.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ ICmaReportRepository.cs
â”‚   â”‚       â”‚   â”œâ”€â”€ ISocialMediaBrowserService.cs
â”‚   â”‚       â”‚   â””â”€â”€ IManualLinkInputService.cs
â”‚   â”‚       â”œâ”€â”€ /Services
â”‚   â”‚       â”‚   â””â”€â”€ CmaOrchestrator.cs
â”‚   â”‚       â””â”€â”€ /Validators
â”‚   â”‚           â”œâ”€â”€ PropertyInputValidator.cs
â”‚   â”‚           â””â”€â”€ SocialMediaLinkValidator.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ /CRM.Infrastructure
â”‚   â”‚   â”œâ”€â”€ /AiAgent
â”‚   â”‚   â”‚   â”œâ”€â”€ AnalyzerAgent.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ VerifierAgent.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ AgentPromptBuilder.cs
â”‚   â”‚   â”‚   â””â”€â”€ LlmApiClient.cs
â”‚   â”‚   â”œâ”€â”€ /Convergence
â”‚   â”‚   â”‚   â”œâ”€â”€ ConvergenceDetector.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ ConsensusBuilder.cs
â”‚   â”‚   â”‚   â””â”€â”€ JaccardCalculator.cs
â”‚   â”‚   â”œâ”€â”€ /Converters
â”‚   â”‚   â”‚   â”œâ”€â”€ CsvParser.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ ClosedXmlGenerator.cs
â”‚   â”‚   â”‚   â””â”€â”€ QuestPdfGenerator.cs
â”‚   â”‚   â”œâ”€â”€ /Persistence
â”‚   â”‚   â”‚   â”œâ”€â”€ CrmDbContext.cs
â”‚   â”‚   â”‚   â””â”€â”€ SqliteCmaReportRepository.cs
â”‚   â”‚   â”œâ”€â”€ /SocialMedia                        # NEW: Tier 2 Portal Access
â”‚   â”‚   â”‚   â”œâ”€â”€ SocialMediaBrowserService.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ FacebookMarketplaceScraper.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ InstagramPropertyScraper.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ WebView2SessionManager.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ HumanLikeDelayGenerator.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ RateLimitDetector.cs
â”‚   â”‚   â”‚   â””â”€â”€ ManualLinkInputService.cs
â”‚   â”‚   â”œâ”€â”€ /Security                           # NEW: Session Management
â”‚   â”‚   â”‚   â”œâ”€â”€ SecureSessionStorage.cs
â”‚   â”‚   â”‚   â””â”€â”€ UserConsentManager.cs
â”‚   â”‚   â””â”€â”€ /Configuration
â”‚   â”‚       â”œâ”€â”€ PortalConfiguration.cs
â”‚   â”‚       â””â”€â”€ SocialMediaConfiguration.cs
â”‚   â”‚
â”‚   â””â”€â”€ /CRM.WPF
â”‚       â”œâ”€â”€ /Views/CmaPlugin
â”‚       â”‚   â”œâ”€â”€ PropertyFormView.xaml
â”‚       â”‚   â”œâ”€â”€ CmaProgressView.xaml
â”‚       â”‚   â”œâ”€â”€ ReportViewerView.xaml
â”‚       â”‚   â”œâ”€â”€ SocialMediaLoginView.xaml       # NEW: WebView2 login
â”‚       â”‚   â”œâ”€â”€ ManualLinkInputView.xaml        # NEW: Fallback UI
â”‚       â”‚   â””â”€â”€ UserConsentDialog.xaml          # NEW: GDPR consent
â”‚       â””â”€â”€ /ViewModels/CmaPlugin
â”‚           â”œâ”€â”€ PropertyFormViewModel.cs
â”‚           â”œâ”€â”€ CmaProgressViewModel.cs
â”‚           â”œâ”€â”€ ReportViewerViewModel.cs
â”‚           â”œâ”€â”€ SocialMediaLoginViewModel.cs
â”‚           â””â”€â”€ ManualLinkInputViewModel.cs
â”‚
â””â”€â”€ /tests
    â”œâ”€â”€ /CRM.Domain.Tests
    â”œâ”€â”€ /CRM.Application.Tests
    â”‚   â””â”€â”€ /CmaPlugin
    â”‚       â”œâ”€â”€ ConvergenceCriteriaTests.cs
    â”‚       â”œâ”€â”€ PropertyInputValidatorTests.cs
    â”‚       â””â”€â”€ SocialMediaLinkValidatorTests.cs
    â”œâ”€â”€ /CRM.Infrastructure.Tests
    â”‚   â”œâ”€â”€ /Convergence
    â”‚   â”‚   â”œâ”€â”€ ConvergenceDetectorTests.cs
    â”‚   â”‚   â”œâ”€â”€ ConsensusBuilderTests.cs
    â”‚   â”‚   â””â”€â”€ JaccardCalculatorTests.cs
    â”‚   â”œâ”€â”€ /AiAgent
    â”‚   â”‚   â””â”€â”€ VerifierAgentTests.cs
    â”‚   â””â”€â”€ /SocialMedia                        # NEW
    â”‚       â”œâ”€â”€ SocialMediaBrowserServiceTests.cs
    â”‚       â”œâ”€â”€ RateLimitDetectorTests.cs
    â”‚       â””â”€â”€ HumanLikeDelayGeneratorTests.cs
    â””â”€â”€ /CRM.Integration.Tests
        â””â”€â”€ CmaPluginIntegrationTests.cs
```

---

## 10. Traceability Matrix

| Requirement ID | Function | Test Class | Implementation Class |
|----------------|----------|------------|---------------------|
| CMA-FORM-001 | Property Input GUI | PropertyFormViewModelTests | PropertyFormViewModel |
| CMA-FORM-002 | Input Validation | PropertyInputValidatorTests | PropertyInputValidator |
| CMA-AGENT-001 | Analyzer Execution | AnalyzerAgentTests | AnalyzerAgent |
| CMA-AGENT-002 | Verifier Loop | VerifierAgentTests | VerifierAgent |
| CMA-CONV-001 | Jaccard Calculation | JaccardCalculatorTests | JaccardCalculator |
| CMA-CONV-002 | Convergence Detection | ConvergenceDetectorTests | ConvergenceDetector |
| CMA-CONV-003 | Consensus Building | ConsensusBuilderTests | ConsensusBuilder |
| CMA-REPORT-001 | CSV Generation | CsvParserTests | CsvParser |
| CMA-REPORT-002 | XLSX Generation | ClosedXmlGeneratorTests | ClosedXmlGenerator |
| CMA-REPORT-003 | PDF Generation | QuestPdfGeneratorTests | QuestPdfGenerator |
| CMA-PERSIST-001 | Report Storage | CmaReportRepositoryTests | SqliteCmaReportRepository |
| CMA-NOTIFY-001 | CRM Notification | CrmNotificationServiceTests | CrmNotificationService |
| CMA-SOCIAL-001 | Facebook Browser Access | SocialMediaBrowserServiceTests | SocialMediaBrowserService |
| CMA-SOCIAL-002 | Instagram Browser Access | SocialMediaBrowserServiceTests | SocialMediaBrowserService |
| CMA-SOCIAL-003 | Rate Limit Detection | RateLimitDetectorTests | RateLimitDetector |
| CMA-SOCIAL-004 | Human-like Delays | HumanLikeDelayGeneratorTests | HumanLikeDelayGenerator |
| CMA-SOCIAL-005 | Manual Link Input | ManualLinkInputServiceTests | ManualLinkInputService |
| CMA-SOCIAL-006 | User Consent Management | UserConsentManagerTests | UserConsentManager |
| CMA-SOCIAL-007 | Secure Session Storage | SecureSessionStorageTests | SecureSessionStorage |

---

## 11. Performance Targets

| Operation | Target | Notes |
|-----------|--------|-------|
| Form Load | < 500ms | Plugin initialization |
| Single Analysis Iteration | < 15 seconds | One analyzer agent run |
| Full Convergence (2 iterations) | < 35 seconds | Best case |
| Full Convergence (5 iterations) | < 90 seconds | Worst case before failure |
| Link Verification | < 100ms per link | Parallel HTTP HEAD |
| CSV â†’ XLSX Conversion | < 2 seconds | For 50 properties |
| CSV â†’ PDF Conversion | < 5 seconds | With styling |
| Database Persistence | < 1 second | BLOB write |

---

## 12. Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| Language | C# 12 | .NET 8 LTS, nullable reference types |
| Framework | .NET 8.0 | Windows desktop, long-term support |
| UI | WPF (MVVM) | Native Windows, rich controls |
| Embedded Browser | WebView2 (Edge/Chromium) | Social media access, native Windows integration |
| Database | SQLite | Offline-first, single file |
| XLSX Generation | ClosedXML | MIT license, no Office dependency |
| PDF Generation | QuestPDF | Fluent API, MIT license |
| Validation | FluentValidation | Declarative rules |
| DI Container | Microsoft.Extensions.DependencyInjection | Standard .NET |
| Secure Storage | Windows Credential Manager | Session cookie encryption |
| Testing | xUnit + FluentAssertions + Moq | Industry standard |
| LLM API | Claude API / OpenAI | Configurable provider |

---

## 13. Risks and Mitigations (Social Media Access)

### 13.1 Risk Assessment Matrix

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| User account suspension | Medium | High | User-delegated model (user's own account), human-like delays, low request volume |
| IP ban from Meta | Low | Medium | Residential IP (user's own), not datacenter; graceful fallback to manual input |
| CAPTCHA blocks | Medium | Low | Present CAPTCHA to user in WebView2 for manual solving |
| Legal action from Meta | Very Low | High | User accesses own account with explicit consent; no TOS violation by CRM itself |
| Session expiration | High | Low | Detect and prompt user to re-authenticate |
| Rate limiting | High | Medium | Exponential backoff, fall back to manual link input |
| Data quality from social media | Medium | Medium | Cross-validate with Tier 1 portals, flag unverified data |
| User privacy concerns | Medium | Medium | Explicit consent dialogs, secure credential storage, transparent operation |

### 13.2 Legal Compliance Checklist

- [ ] User explicitly consents to browser automation (GDPR/CCPA)
- [ ] Session cookies stored in Windows Credential Manager (encrypted)
- [ ] User can revoke consent and delete stored sessions at any time
- [ ] No credentials stored (only session cookies after user login)
- [ ] All automation visible to user (no hidden browser windows)
- [ ] Rate limits respected (human-like delays enforced)
- [ ] User can switch to manual mode at any time

### 13.3 Fallback Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SOCIAL MEDIA FALLBACK HIERARCHY                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Priority 1: Automated WebView2 browsing with user session
       â”‚
       â”‚ If blocked/rate-limited/CAPTCHA
       â–¼
  Priority 2: User solves CAPTCHA in WebView2, automation continues
       â”‚
       â”‚ If still blocked
       â–¼
  Priority 3: Manual link input (user searches, pastes URLs)
       â”‚
       â”‚ If user declines
       â–¼
  Priority 4: Skip social media sources (use only Tier 1 portals)
```

---

## 14. Open Questions

1. **LLM Provider**: Which API will be used? (Claude, OpenAI, Azure OpenAI, local Ollama?)

2. **Non-Convergence Strategy**: When convergence fails after max iterations:
   - (A) Fail completely, require parameter adjustment
   - (B) Return partial results with warning
   - (C) Offer manual review of divergent results

3. **Cost Control**: Should there be a token/cost budget cap per CMA request?

4. **Report Template**: Is there an existing ACM report format/template to follow for XLSX/PDF layout?

5. **Offline Agent**: Can the analyzer agent work offline, or does it require live portal access?

6. **Social Media Priority**: Should Facebook/Instagram be searched by default, or only on user request?

7. **Session Persistence**: How long should social media sessions be cached before requiring re-authentication?

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-04 | - | Initial design specification |
| 1.1 | 2026-01-04 | - | Added Facebook/Instagram integration with tiered portal architecture, user-delegated access model, risks and mitigations |
